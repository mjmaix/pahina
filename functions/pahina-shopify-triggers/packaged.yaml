AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'SAM Template for pahina-shop-triggers

  '
Parameters:
  EnvType:
    Description: Environment for this function
    Type: String
    Default: dev
    AllowedValues:
    - dev
    - prod
    - test
    - NONE
  ShopifyApiKey:
    Description: Shopify API Key
    Type: AWS::SSM::Parameter::Value<String>
    Default: shpy_freemjabadilla_gql_api_key
  ShopifyApiPwd:
    Description: Shopify password
    Type: AWS::SSM::Parameter::Value<String>
    Default: shpy_freemjabadilla_gql_api_pwd
  ShopifyGqlApiHost:
    Description: Shopify hostname
    Type: String
    Default: freelitemjabadilla.myshopify.com
Mappings:
  EnvConfigMap:
    BatchSize:
      dev: 2
      prod: 10
  AmplifyProject:
    GraphQLAPIIdOutput:
      dev: 3bhpj3dbivcpfmp7olov6zcody
      prod: ''
Conditions:
  IsDev:
    Fn::Equals:
    - Ref: EnvType
    - dev
  ShouldNotCreateEnvResources:
    Fn::Equals:
    - Ref: EnvType
    - NONE
Globals:
  Function:
    Handler: app.handler
    Timeout: 30
    Runtime: nodejs10.x
    Environment:
      Variables:
        SHOPIFY_API_KEY:
          Ref: ShopifyApiKey
        SHOPIFY_API_PWD:
          Ref: ShopifyApiPwd
        SHOPIFY_API_HOSTNAME:
          Ref: ShopifyGqlApiHost
        REGION:
          Ref: AWS::Region
Resources:
  NoteStreamFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://pahina-shopify-triggers/c90929d21ebabc2e8911cdd600c26e8a
      Events:
        StreamEvent:
          Type: DynamoDB
          Properties:
            Stream:
              Fn::ImportValue:
                Fn::Join:
                - ':'
                - - Fn::FindInMap:
                    - AmplifyProject
                    - GraphQLAPIIdOutput
                    - Ref: EnvType
                  - GetAtt
                  - PahinaNoteTable
                  - StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize:
              Fn::FindInMap:
              - EnvConfigMap
              - BatchSize
              - Ref: EnvType
            Enabled: true
  UserStreamFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://pahina-shopify-triggers/1df6f3d4ca9aa5c69a893d1f19890b22
      Environment:
        Variables:
          USER_STORE_TABLE_NAME:
            Fn::ImportValue:
              Fn::Join:
              - ':'
              - - Fn::FindInMap:
                  - AmplifyProject
                  - GraphQLAPIIdOutput
                  - Ref: EnvType
                - GetAtt
                - PahinaUserStoreTable
                - Name
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Fn::ImportValue:
              Fn::Join:
              - ':'
              - - Fn::FindInMap:
                  - AmplifyProject
                  - GraphQLAPIIdOutput
                  - Ref: EnvType
                - GetAtt
                - PahinaUserStoreTable
                - Name
      Events:
        StreamEvent:
          Type: DynamoDB
          Properties:
            Stream:
              Fn::ImportValue:
                Fn::Join:
                - ':'
                - - Fn::FindInMap:
                    - AmplifyProject
                    - GraphQLAPIIdOutput
                    - Ref: EnvType
                  - GetAtt
                  - PahinaUserTable
                  - StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 1
            Enabled: true
Outputs:
  NoteStreamFunction:
    Description: NoteStream Function ARN
    Value:
      Fn::GetAtt:
      - NoteStreamFunction
      - Arn
  NoteStreamFunctionIamRole:
    Description: Implicit IAM Role created for NoteStream Function
    Value:
      Fn::GetAtt:
      - NoteStreamFunctionRole
      - Arn
  UserStreamFunction:
    Description: UserStream Function ARN
    Value:
      Fn::GetAtt:
      - UserStreamFunction
      - Arn
  UserStreamFunctionIamRole:
    Description: Implicit IAM Role created for UserStream Function
    Value:
      Fn::GetAtt:
      - UserStreamFunctionRole
      - Arn
